---
title: "ReIDä»»åŠ¡ä¸­çš„CMCå’ŒmAP"
date: 2019-02-23T16:33:24+08:00
categories:
- å­¦æœ¯
markup: pandoc
tags:
- ReID
- Pytorch
description: è¯¦ç»†è®²è§£ReIDä»»åŠ¡ä¸­çš„CMCå’ŒmAP
spotlight: true
math: true
---

## ReID

ReIDæŒ‡Re-identificationï¼Œå¸¸ç¿»è¯‘ä¸ºé‡è¯†åˆ«ã€‚ReIDä»»åŠ¡æœ¬èº«åˆ†ç±»å¾ˆå¤šï¼Œæœ¬æ–‡åªè®¨è®ºåŸºäºå›¾ç‰‡çš„ReIDä»»åŠ¡ä¸­`single-gallery-shot`è¿™ä¸€æœ€ç®€å•çš„æƒ…å†µã€‚

é‡è¯†åˆ«ä»»åŠ¡å¯ä»¥æè¿°å¦‚ä¸‹ï¼š

ç»™å®šä¸€ä¸ªGalleryé›†åˆ$G$ï¼ŒåŒ…å«æœ‰$N$å¼ å›¾ç‰‡ï¼Œåˆ†å±$M$ä¸ªID(identity)ã€‚ç»™å®šä¸€å¼ æœªçŸ¥IDçš„å›¾ç‰‡åšquery(æˆ–è€…å«probe), è®¡ç®—å‡ºä¸‹å¼çš„ç»“æœï¼š$max(Similarity(query, g_i)), i\in1,2,3,...,N, g_i\in G$ã€‚å¾—åˆ°iä¹‹åï¼Œå›¾ç‰‡$g_i$å¯¹åº”çš„IDå°±æ˜¯queryçš„IDã€‚å¤§éƒ¨åˆ†ReIDç›¸å…³çš„ç ”ç©¶ï¼Œéƒ½æ˜¯åœ¨ç ”ç©¶`Similarity()`è¿™ä¸ªå‡½æ•°ï¼Œä½¿å¾—è¿™ä¸ªå‡½æ•°**åœ¨åŒIDæ—¶è¿”å›å€¼é«˜ï¼Œä¸åŒIDæ—¶è¿”å›å€¼ä½**ã€‚

ä¸‹å›¾å°±æ˜¯ä¸€æ¬¡å…¸å‹çš„é‡è¯†åˆ«ä»»åŠ¡:![re-id](ranked_results.jpg)

ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘åœ¨è¿™ç¯‡æ–‡ä¸­ä»‹ç»ä¸€ä¸ªæ–°çš„é‡è¯†åˆ«ä»»åŠ¡ï¼š*æ°´æœemojié‡è¯†åˆ«*ã€‚

æˆ‘ä»¬ç°æœ‰ä¸€ä¸ªæ°´æœemojiçš„æ•°æ®é›†$G$ï¼š[ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ]ï¼Œå‡å®šè¿™ä¸ªæ•°æ®é›†ä¸­ï¼Œå³ä½¿æ˜¯ç›¸åŒçš„emojiï¼Œå›¾ç‰‡ä¹Ÿæœ‰ç»†å°çš„å·®åˆ«ã€‚
æ•°æ®é›†ä¸€å…±åŒ…å«$N=15$å¼ å›¾ç‰‡ï¼Œå…±æœ‰$M=3$ç§IDã€‚ä»»æ„ç»™å®šä¸€ç»„query: [ğŸ,ğŸ]ï¼Œä»æ•°æ®é›†$G$ä¸­æ‰¾åˆ°å’Œæ¯ä¸ªqueryæœ€ç›¸è¿‘çš„5å¼ å›¾ç‰‡(ä¸ºäº†ä¿è¯å‡†ç¡®ç‡ï¼Œæˆ‘ä»¬éƒ½æ˜¯è¿”å›ä¸€ç»„æœ€ç›¸è¿‘çš„å›¾ç‰‡ï¼Œè€Œä¸æ˜¯å¦‚å‰æ–‡æ‰€è¿°çš„å•ç‹¬ä¸€å¼ å›¾ç‰‡)ã€‚

æˆ‘ä»¬ç°åœ¨æœ‰ä¸¤ä¸ªè¯„ä»·emojiä¹‹é—´ç›¸ä¼¼ç¨‹åº¦çš„å‡½æ•°`Similarity1()`å’Œ`Similarity2()`ã€‚
å¯¹äºqueryğŸï¼Œ`Similarity1()`å¾—åˆ°[ğŸğŸğŸğŸğŸ]ï¼Œ`Similarity2()`å¾—åˆ°[ğŸğŸğŸğŸğŸ]ã€‚
å¯¹äºqueryğŸï¼Œ`Similarity1()`å¾—åˆ°[ğŸğŸğŸğŸğŸ]ï¼Œ`Similarity2()`å¾—åˆ°[ğŸğŸğŸğŸğŸ]ã€‚
å¾—åˆ°çš„ç»“æœéƒ½æŒ‰ä¸queryçš„ç›¸ä¼¼åº¦ä»å·¦è‡³å³æ’åˆ—ã€‚é‚£ä¹ˆ`Similarity1()`å’Œ`Similarity2()`å“ªä¸ªå¾—åˆ°çš„ç»“æœæ›´å¥½å‘¢ï¼Ÿ

æˆ–è€…è¯´ï¼šæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåº¦é‡`Similarity()`å‡½æ•°çš„æ€§èƒ½ï¼Ÿç­”æ¡ˆå°±æ˜¯**CMC**å’Œ**mAP**ã€‚

## CMC

CMCæ˜¯`Cumulative Matching Characteristics`çš„ç¼©å†™ï¼Œæˆ‘ä¸ªäººæŠŠå®ƒç¿»è¯‘ä¸º`ç´¯è®¡åŒ¹é…ç‰¹æ€§`ã€‚ReIDæ¨¡å‹çš„å¥½åå¯ä»¥é€šè¿‡CMCæ›²çº¿æ¥è¯„ä»·ã€‚
ä¸ºäº†è®¡ç®—CMCæ›²çº¿ï¼Œé¦–å…ˆè¦æŠŠæ¯æ¬¡æŸ¥è¯¢çš„ç»“æœæŒ‰ç›¸ä¼¼ç¨‹åº¦æ’åºã€‚æ¥ç€ï¼Œå¼•å…¥ä¸€ä¸ªæ¦‚å¿µ: $topK$å‡†ç¡®åº¦: $AccK$ï¼Œå…¶è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š
$$AccK=
\begin{cases}
1& \text{å‰Kä¸ªç»“æœä¸­æœ‰åŒIDçš„ç»“æœ}\\
0& \text{å‰Kä¸ªç»“æœä¸­æ²¡æœ‰åŒIDçš„ç»“æœ}
\end{cases}
$$
è¿™é‡Œçš„Kæ˜¯ä¸€ä¸ªä»1å¼€å§‹å¢åŠ çš„å˜é‡ã€‚æ˜¾ç„¶ï¼Œ$AccK$å½¢åŒå•ä½é˜¶è·ƒå‡½æ•°ã€‚å‡è®¾åœ¨æŸ¥è¯¢å¾—åˆ°çš„ç»“æœä¸­ï¼Œä¸queryåŒIDçš„ç»“æœç¬¬ä¸€æ¬¡å‡ºç°æ—¶çš„æ’åä¸º$F$ï¼Œé‚£ä¹ˆæ˜¾ç„¶ï¼Œ$AccK$åœ¨$K=F$æ—¶ï¼Œå€¼ç”±0å˜ä¸º1ã€‚
CMCæ›²çº¿çš„è®¡ç®—æ–¹æ³•å°±æ˜¯ï¼ŒæŠŠæ¯ä¸ªqueryçš„$AccK$æ›²çº¿ç›¸åŠ ï¼Œå†é™¤ä»¥queryçš„æ€»æ•°ï¼Œå³å¹³å‡$AccK$æ›²çº¿ã€‚

å›åˆ°æˆ‘ä»¬çš„*æ°´æœemojié‡è¯†åˆ«*ä»»åŠ¡ã€‚
åˆ†åˆ«è®¡ç®—ä¸¤ä¸ªqueryçš„AccKæ›²çº¿å¦‚ä¸‹ï¼š

```text
Similarity    1          2
queryğŸ: 0 1 1 1 1 | 1 1 1 1 1
queryğŸ: 1 1 1 1 1 | 0 1 1 1 1
```

å†å¹³å‡å„ä¸ªqueryçš„AccKæ›²çº¿ï¼Œç”±æ­¤æˆ‘ä»¬å¾—åˆ°è¿™ä¸¤ç§ç›¸ä¼¼åº¦å‡½æ•°çš„CMCæ›²çº¿éƒ½æ˜¯[0.5ï¼Œ1ï¼Œ1ï¼Œ1ï¼Œ1]
ç”±äºqueryåªæœ‰ä¸¤ä¸ªï¼Œæ‰€ä»¥å¾—åˆ°çš„CMCçš„å€¼æœ‰äº›ç®€å•ã€‚ä½†æ˜¯å½“queryæ•°è¶³å¤Ÿå¤§æ—¶ï¼ŒCMCæ›²çº¿å°±ä¼šå˜æˆä¸‹å›¾è¿™æ ·ï¼š
![CMCæ›²çº¿](CMC.png)
ç”±äºAccKæ›²çº¿æ˜¯ä¸€ä¸ªå•ä½é˜¶è·ƒå‡½æ•°ï¼ŒCMCæ›²çº¿å¿…å®šæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„æ›²çº¿ã€‚æ›²çº¿ä¸ŠæŸä¸ªç‚¹å¦‚(R5, 0.96)å°±è¡¨ç¤ºæ­£ç¡®ç»“æœåœ¨å‰è¿”å›æ‰€æœ‰ç»“æœä¸­æ’åå‰5çš„å‡†ç¡®ç‡èƒ½è¾¾åˆ°96%ã€‚
å®é™…è®ºæ–‡ä¸­ï¼Œå¸¸å–CMCæ›²çº¿ä¸Šçš„æŸå‡ ä¸ªç‚¹ä¹‹é—´å¯¹æ¯”ï¼Œæ¯”å¦‚å¸¸å‡ºç°çš„Rank1ï¼ŒRank5ï¼Œå°±åˆ†åˆ«æ˜¯CMCæ›²çº¿ä¸Šï¼ŒK=1ï¼Œ5æ—¶çš„å€¼ã€‚

## mAP

mAPæ˜¯mean Average Precisionçš„ç¼©å†™ã€‚mAPæ¶‰åŠåˆ°çš„å‰ç½®æ¦‚å¿µæ¯”è¾ƒå¤šï¼šmAPæ˜¯æ¯ä¸ªqueryçš„AP(Average Precision)çš„å¹³å‡å€¼ï¼Œè€ŒAPåˆæŒ‡Precision(å‡†ç¡®ç‡ï¼Œåˆç§°æŸ¥å‡†ç‡)çš„å¹³å‡å€¼ã€‚æˆ‘ä»¬ä»å¤´å¼€å§‹è®²èµ·ã€‚

å¯¹äºReIDä»»åŠ¡ï¼Œæˆ‘ä»¬ç»å¸¸å…³å¿ƒä¸¤ä¸ªé—®é¢˜ï¼š

1. æŸ¥è¯¢å¾—åˆ°çš„ç»“æœä¸­ï¼Œå’ŒæŸ¥è¯¢å›¾ç‰‡åŒä¸€IDçš„ç»“æœå æ¯”å¤šå°‘?
2. åŒä¸€IDçš„å›¾ç‰‡ä¸­ï¼Œæœ‰å¤šå¤§æ¯”ä¾‹çš„å›¾ç‰‡è¢«æ£€ç´¢å‡ºæ¥äº†?

è¿™ä¸¤ä¸ªé—®é¢˜åˆ†åˆ«å¯¹åº”`æŸ¥å‡†ç‡(precision)`å’Œ`æŸ¥å…¨ç‡(recall)`ï¼Œäº¦ç§°ä½œ`å‡†ç¡®ç‡`å’Œ`å¬å›ç‡`ã€‚å› ä¸º`å‡†ç¡®ç‡`è¿™ä¸ªç§°å‘¼åœ¨åˆ«çš„é¢†åŸŸæœ‰å…¶å®ƒæ„ä¹‰ï¼Œä¸ºäº†é˜²æ­¢è¯¯è§£ï¼Œæˆ‘è¿˜æ˜¯å–œæ¬¢ç”¨`æŸ¥å‡†ç‡`å’Œ`æŸ¥å…¨ç‡`çš„è¯´æ³•ã€‚

### æŸ¥å‡†ç‡å’ŒæŸ¥å…¨ç‡

**æŸ¥å‡†ç‡**å°±æ˜¯å’ŒqueryåŒä¸€IDçš„å›¾ç‰‡åœ¨æŸ¥è¯¢ç»“æœä¸­çš„å æ¯”ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹:
$$
precision = \frac{\mid\{åŒIDå›¾ç‰‡\}\cap\{æŸ¥è¯¢ç»“æœ\}\mid}{\mid\{æŸ¥è¯¢ç»“æœ\}\mid}
$$
æŸ¥å‡†ç‡å¯ä»¥åŒæ—¶è€ƒè™‘æ‰€æœ‰çš„è·å–åˆ°çš„ç»“æœï¼Œä¹Ÿå¯ä»¥å•ç‹¬ç»™å®šä¸€ä¸ªç‰¹å®šçš„å€¼Kï¼Œåªè€ƒè™‘è¿”å›ç»“æœä¸­æ’åå‰Kçš„æŸ¥è¯¢ç»“æœï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸ¥å‡†ç‡åˆå¯ä»¥ç§°ä¸ºå‰KæŸ¥å‡†ç‡ï¼Œè®°ä½œP@Kã€‚

**æŸ¥å…¨ç‡**å°±æ˜¯å’ŒqueryåŒä¸€IDçš„å›¾ç‰‡å‡ºç°åœ¨æŸ¥è¯¢ç»“æœä¸­çš„æ•°é‡å æ€»æ•°çš„æ¯”ä¾‹ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š
$$
recall = \frac{\mid\{åŒIDå›¾ç‰‡\}\cap\{æŸ¥è¯¢ç»“æœ\}\mid}{\mid\{åŒIDå›¾ç‰‡\}\mid}
$$
æŸ¥å‡†ç‡å’ŒæŸ¥å…¨ç‡çœ‹ä¸Šå»éƒ½å¾ˆæœ‰æ„ä¹‰ï¼Œä½†æˆ‘ä»¬èƒ½ç›´æ¥ç”¨å®ƒä¿©æ¥è¯„åˆ¤ReIDæ¨¡å‹çš„æ€§èƒ½äº†å—ï¼Ÿå½“ç„¶ä¸è¡Œï¼Œç”±äºæŸ¥å‡†ç‡å’ŒæŸ¥å…¨ç‡éƒ½æ˜¯é€šè¿‡æ¯”ä¾‹æ¥è®¡ç®—ï¼Œå®Œå…¨å¿½ç•¥äº†è¿”å›ç»“æœçš„æ’åºï¼å½“æŸ¥è¯¢ğŸæ—¶ï¼Œè¿”å›ğŸğŸğŸğŸğŸå’ŒğŸğŸğŸğŸğŸå½“ç„¶æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†å…¶æŸ¥å‡†ç‡å’ŒæŸ¥å…¨ç‡å´æ˜¯ä¸€æ ·çš„ã€‚è¿”å›ç»“æœçš„é¡ºåºè¢«å¿½ç•¥äº†ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒæŸ¥å‡†ç‡å’ŒæŸ¥å…¨ç‡æ˜¯ä¸€ä¸ªç›¸äº’çŸ›ç›¾çš„åº¦é‡ï¼Œæ¯”å¦‚ä¸ºäº†å¢åŠ æŸ¥å…¨ç‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ æŸ¥è¯¢ç»“æœçš„æ•°é‡æ¥å®ç°ï¼Œå½“æŸ¥è¯¢ç»“æœæ•°é‡ç­‰äºæ•°æ®é›†å¤§å°æ—¶ï¼ŒæŸ¥å…¨ç‡ä¸€å®šç­‰äº1ï¼Œå› ä¸ºè¿™æ—¶æ‰€æœ‰å›¾ç‰‡éƒ½è¢«æŸ¥è¯¢å¾—åˆ°äº†ã€‚ä½†æ­¤æ—¶æŸ¥å‡†ç‡å°±æˆäº†æœ€å°å€¼ã€‚æ‰€ä»¥æ¯”è¾ƒæ¨¡å‹çš„æ€§èƒ½ä¸æ˜¯é‚£ä¹ˆç®€å•çš„äº‹æƒ…ã€‚

### P-Ræ›²çº¿å›¾

é‚£æ€ä¹ˆæ¯”å‘¢ï¼Ÿè‚‰çœ¼æ¯”å¯¹æ—¶ï¼Œæˆ‘ä»¬å¸¸ä»ç»“æœçš„ç¬¬ä¸€ä¸ªå¼€å§‹ï¼Œä¸€ä¸ªä¸€ä¸ªæ¯”å¯¹ã€‚å€Ÿé‰´è¿™ç§æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥é€æ¸å¢åŠ æŸ¥è¯¢ç»“æœçš„æ•°é‡ï¼Œä»ç¬¬ä¸€ä¸ªå¼€å§‹ï¼Œä¸€ç›´åˆ°ç³»ç»Ÿç»™å‡ºçš„æŸ¥è¯¢ç»“æœçš„æœ€åä¸€ä¸ªï¼ŒæŠŠä¸­é—´æ¯ä¸ªç‚¹å¯¹åº”çš„æŸ¥å‡†ç‡å’ŒæŸ¥å…¨ç‡è®¡ç®—å‡ºæ¥ç„¶åç»˜åˆ¶åˆ°ä¸€å¼ å›¾ä¸Šã€‚

æˆ‘ä»¬æ¥ç€æ‹¿æ°´æœemojié‡è¯†åˆ«ä»»åŠ¡åšä¾‹å­ï¼Œå¯¹äºqueryğŸï¼Œ`Similarity1()`å¾—åˆ°[ğŸğŸğŸğŸğŸ]ï¼Œ`Similarity2()`å¾—åˆ°[ğŸğŸğŸğŸğŸ]ã€‚æˆ‘ä»¬ç°åœ¨é¦–å…ˆç»˜å‡ºæ­¤æ—¶ä¸¤ç§æ–¹æ³•çš„P-Ræ›²çº¿ã€‚æ³¨æ„ï¼Œç”±å‰æ–‡çš„ä»»åŠ¡å®šä¹‰å¾—$\mid\{åŒIDå›¾ç‰‡\}\mid=5$

| åºå· | Similarity1 |        | Similarity2 |        |
|:------:|:-----------:|:------:|:-----------:|:------:|
|      |    æŸ¥å…¨ç‡   | æŸ¥å‡†ç‡ |    æŸ¥å…¨ç‡   | æŸ¥å‡†ç‡ |
| 1    |     0.2     |    1   |      0      |    0   |
| 2    |     0.2     |   0.5  |     0.2     |   0.5  |
| 3    |     0.2     |  0.33  |     0.4     |  0.66  |
| 4    |     0.4     |   0.5  |     0.6     |  0.75  |
| 5    |     0.6     |   0.6  |     0.6     |   0.6  |

æ¥ç€å°†è¿™äº›ç‚¹ç»˜åˆ¶åœ¨ä¸€å¼ å›¾ä¸Šï¼š

![ç®€å•æ•°æ®PRå›¾](image-20200430003113257.png)

ç”±äº5ä¸ªç‚¹å¤ªå°‘ï¼Œä¸Šå›¾ä¸­æ›²çº¿è¿˜æ²¡è¡¨ç°å‡ºæ˜æ˜¾çš„è¶‹åŠ¿ã€‚å®é™…ä¸Šï¼Œåœ¨æŸ¥è¯¢é‡è¶³å¤Ÿå¤§æ—¶ï¼ŒP-Rå›¾ä¸€èˆ¬éƒ½ç±»ä¼¼äºä¸‹å›¾ï¼š

![å¤æ‚æ•°æ®PRå›¾](PR.jpg)

P-Rå›¾ç›´è§‚åœ°æ˜¾ç¤ºå‡ºäº†ReIDæ¨¡å‹çš„æŸ¥å…¨ç‡å’ŒæŸ¥å‡†ç‡ï¼Œæ˜¾è€Œæ˜“è§ï¼Œå¦‚æœä¸€ä¸ªæ¨¡å‹çš„P-Ræ›²çº¿åŒ…ä½äº†å¦ä¸€ä¸ªæ¨¡å‹çš„P-Ræ›²çº¿ï¼Œè¿™ä¸ªæ¨¡å‹çš„æ€§èƒ½å°±å¥½äºå¦ä¸€ä¸ªæ¨¡å‹ã€‚

### Average Precision

æ˜¾ç„¶ï¼ŒPRæ›²çº¿ä¸åæ ‡è½´å›´èµ·æ¥å›¾å½¢çš„é¢ç§¯ä¸€å®šç¨‹åº¦ä¸Šååº”äº†ReIDæ¨¡å‹çš„æ€§èƒ½ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªé¢ç§¯å«åšAverage Precisionã€‚è¿™ä¸ªé¢ç§¯æ€ä¹ˆæ±‚ï¼Ÿç”±ç§¯åˆ†çŸ¥è¯†å¯å¾—:
$$
AveP = \int_{0}^1p(r)dr
$$
å¯æƒœï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ˜¯æ›²çº¿ä¸Šä¸€ä¸ªä¸ªç‚¹ï¼Œå¾—ä¸åˆ°$p(r)$çš„å‡†ç¡®å…¬å¼ï¼Œæ²¡æ³•ç”¨ä¸Šé¢çš„å…¬å¼è®¡ç®—ã€‚ä½†è®¡ç®—APçš„è¿‡ç¨‹å·²ç»å¯ä»¥è¢«å½’ç»“ä¸ºè¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼š

*å‡è®¾ä¸€å…±è¿”å›$N$ä¸ªæŸ¥è¯¢ç»“æœï¼Œè®¡ç®—Nä¸ªç‚¹$\{(recall_k, precision_k), k\in1,2,3,...,N\}$çš„ç¦»æ•£ç§¯åˆ†ã€‚*

æ˜¾ç„¶ï¼Œå¯ä»¥ç”¨å¤šä¸ªé•¿æ–¹å½¢æ¡çš„é¢ç§¯ä¹‹å’Œè¡¨ç¤ºç§¯åˆ†ç»“æœã€‚
$$AveP = \sum_{k=1}^{N}precision_i(recall_k-recall_{k-1})$$

æ‹¿æ°´æœemojié‡è¯†åˆ«ä¸­çš„æŸ¥è¯¢ä¸ºğŸæ—¶çš„`Similarity1`åšä¸ªä¾‹å­ï¼š

![](hand-drawn-pr.png)

æ³¨æ„ï¼Œå›¾ä¸­rä¸€è‡´ï¼Œpåœ¨å˜å°çš„å‰3ä¸ªç‚¹ä¸­ï¼Œåªæœ‰pæœ€å¤§çš„ç‚¹å¯¹è®¡ç®—ç§¯åˆ†å€¼æœ‰å½±å“ã€‚å› ä¸ºåªæœ‰æ­¤æ—¶$recall_k-recall_{k-1}$å€¼ä¸ä¸º0ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œè®¡ç®—ç§¯åˆ†æ—¶ï¼Œåªéœ€è¦è€ƒè™‘æŸ¥å‡†çš„ç»“æœå¤„(å‡è®¾ä¸ºç¬¬$k$ä¸ªæŸ¥è¯¢ç»“æœ)å¯¹åº”çš„$(recall_k, precision_k)$ã€‚

å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œè¿”å›ç»“æœ[ğŸğŸğŸğŸğŸ]ä¸­ç¬¬2ï¼Œ3ä¸ªç»“æœéƒ½æ²¡æŸ¥å‡†ï¼Œé‚£ä¹ˆå‰2ï¼Œ3ä¸ªç»“æœä¸­æŸ¥å‡†ä¸ªæ•°ä¸å˜ï¼Œå³recallä¿æŒä¸å˜ï¼Œrecallä¿æŒä¸å˜æ„å‘³ç€è¿™å‡ ä¸ªç‚¹åœ¨P-Rå›¾ä¸­ï¼Œä½äºåŒä¸€æ¡å¹³è¡Œäºpè½´çš„ç›´çº¿ä¸Šã€‚ç”±äº$recall_k-recall_{k-1}=0$ï¼Œå®ƒä»¬ä¸å½±å“ç§¯åˆ†ç»“æœã€‚

æ‰€ä»¥å¦‚æœä»¤é›†åˆ$\Omega$ä¸ºå’ŒqueryåŒIDçš„ç¬¬kä¸ªæŸ¥è¯¢ç»“æœçš„é›†åˆï¼Œ$N_t$ä¸ºæ‰€æœ‰ä¸æŸ¥è¯¢å›¾ç‰‡åŒIDçš„å›¾ç‰‡æ•°ç›®ï¼Œ$\Delta recall=1/N_t$ï¼š
$$AveP = \sum_i precision_i\Delta recall, i\in\Omega$$
å¯¹äºæŸ¥è¯¢ç»“æœ[ğŸğŸğŸğŸğŸ], $\Omega=\{1,4,5\}$ï¼Œ$\Delta recall=1/5$ã€‚


ç½‘ä¸ŠæœmAPç›¸å…³æ•™ç¨‹æ—¶ç»å¸¸å‡ºç°çš„å›¾ç‰‡(æ¥è‡ª[yongyuan.name](http://yongyuan.name/blog/evaluation-of-information-retrieval))ç”¨çš„å°±æ˜¯è¿™ä¸ªå…¬å¼ã€‚
![mAP](map.png)


ä¸ºäº†è®¡ç®—APæ›´ç²¾ç¡®ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨æ¢¯å½¢é¢ç§¯å…¬å¼æ›¿æ¢çŸ©å½¢é¢ç§¯ï¼š
$$
AveP = \sum_{k=1}^{N}\frac{precision_k+precision_{k-1}}{2}(recall_k-recall_{k-1})
$$

åŒå‰é¢çš„è®¨è®ºä¸€è‡´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åªè®¡ç®—æŸ¥å‡†ç‚¹çš„æ¢¯å½¢é¢ç§¯ï¼š

$$AveP = \sum_i \frac{precision_i+precision_{i-1}}{2}\Delta recall, i\in\Omega$$

å¦å¤–ï¼Œç¬¬0ä¸ªç»“æœçš„æŸ¥å‡†ç‡æœ¬æ¥æ˜¯æ— æ„ä¹‰çš„ï¼Œä½†æ˜¯ä¸ºäº†è®¡ç®—æ–¹ä¾¿ï¼Œè¡¥å……å®šä¹‰$precision_0=precision_1$ã€‚

> **æ³¨æ„**ï¼š$precision_{i-1}$ä¸æ˜¯$\Omega$é›†åˆä¸­çš„ä¸Šä¸€ä¸ªç‚¹çš„æŸ¥å‡†ç‡ï¼Œè€Œæ˜¯ç¬¬i-1ä¸ªæŸ¥è¯¢ç»“æœå¯¹åº”ç‚¹çš„æŸ¥å‡†ç‡ã€‚
>
> è¯¦ç»†åˆ†æé™„åœ¨äº†æ–‡ç« æœ€åã€‚

æ— è®ºæ˜¯æ¢¯å½¢è¿˜æ˜¯çŸ©å½¢ï¼Œä¸¤ä¸ªå…¬å¼éƒ½å¯ä»¥è®¡ç®—APï¼Œä½†åä¸€ä¸ªå…¬å¼ç²¾ç¡®åº¦æ›´é«˜ä¸€äº›ã€‚

æœ€åï¼Œå¹³å‡ä¸€ä¸‹æ¯ä¸ªqueryçš„APå€¼å°±å¾—åˆ°äº†mAPã€‚
$$mAP = \frac{\sum_{i=1}^{N_q}AveP_i}{N_q}$$

### æ°´æœemojié‡è¯†åˆ«ä»»åŠ¡

å†å›åˆ°æˆ‘æå‡ºçš„æ°´æœemojié‡è¯†åˆ«ä»»åŠ¡ï¼Œæˆ‘ä»¬æ¥è®¡ç®—ä¸‹ä¸¤ç§æ–¹æ³•çš„mAPï¼š

æˆ‘ä»¬ç°åœ¨æœ‰ä¸¤ä¸ªè¯„ä»·emojiä¹‹é—´ç›¸ä¼¼ç¨‹åº¦çš„å‡½æ•°`Similarity1()`å’Œ`Similarity2()`ã€‚
å¯¹äºqueryğŸï¼Œ`Similarity1()`å¾—åˆ°[ğŸğŸğŸğŸğŸ]ï¼Œ`Similarity2()`å¾—åˆ°[ğŸğŸğŸğŸğŸ]ã€‚
å¯¹äºqueryğŸï¼Œ`Similarity1()`å¾—åˆ°[ğŸğŸğŸğŸğŸ]ï¼Œ`Similarity2()`å¾—åˆ°[ğŸğŸğŸğŸğŸ]ã€‚

å¯¹äº`Similarity1()`ï¼š

queryä¸ºğŸæ—¶ï¼Œ$AP=\frac{1+1}{2}*\frac{1}{5}+\frac{0.33+0.5}{2}*\frac{1}{5}+\frac{0.5+0.6}{2}*\frac{1}{5}=0.393$

queryä¸ºğŸæ—¶ï¼Œ$AP=\frac{0+0.5}{2}*\frac{1}{5}+\frac{0.5+0.66}{2}*\frac{1}{5}+\frac{0.66+0.75}{2}*\frac{1}{5}=0.307$

é‚£ä¹ˆ$mAP=\frac{0.393+0.307}{2}=0.35$

å¯¹äº`Similarity2`ï¼ŒåŒç†å¯è®¡ç®—ï¼ŒğŸï¼š$AP=0.457$ï¼ŒğŸï¼š$AP=0.307$ï¼Œ$mAP=0.382$ã€‚

æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆå¾—åˆ°ï¼Œ`Similarity2()`ä¼˜äº`Similarity1()`ã€‚

## ä»£ç å®ç°

ç›¸ä¿¡ä½ åœ¨ç†è§£äº†mAPå’ŒCMCä¹‹åï¼Œå†ç”¨ä»£ç å®ç°å®ƒä¿©å°±å˜å¾—å¾ˆè½»æ¾äº†ã€‚æˆ‘æœ€è¿‘ä¸€ç›´åœ¨åšè¡Œäººé‡è¯†åˆ«çš„é¡¹ç›®ï¼Œå¯ä»¥æ‹¿æˆ‘ä¸€ç›´åœ¨ç”¨çš„[evaluate.py](https://gist.github.com/budui/ba3b2c5868f7d68982191be7db32b453#file-evaluate-py-L28)ä¸­çš„`evaluate_with_index()`å‡½æ•°åšä¸€ä¸ªå‚è€ƒã€‚

## One More Thingï¼š

æˆ‘èµ·åˆæŠŠ$precision_{i-1}$é”™è¯¯åœ°ç†è§£ä¸ºé›†åˆ$\Omega$çš„å‰ä¸€ä¸ªå€¼å¯¹åº”çš„å‡†ç¡®ç‡ï¼Œå› æ­¤å®ç°ä»£ç æ—¶è®¡ç®—$precision_{i-1}$ç”¨çš„æ˜¯ä¸‹é¢è¿™ä¸ªå…¬å¼ï¼š

```python
old_precision = float(i) / (right_index_location[i-1]+1)
```

è¿™é‡Œå’Œä¸€ä¸ªåƒstarçº§åˆ«çš„repo[Person_reID_baseline_pytorch](https://github.com/layumi/Person_reID_baseline_pytorch)ä¸ä¸€è‡´ï¼Œæˆ‘è¿˜ä»¥ä¸ºäººæé”™äº†ï¼Œè¿˜å‘äº†ä¸€ä¸ª[issue](https://github.com/layumi/Person_reID_baseline_pytorch/issues/110)ã€‚å’Œ@[layumi](https://github.com/layumi/)è®¨è®ºåŠå¤©æ‰å‘ç°æˆ‘é”™åœ¨å“ªäº†ã€‚å…¶å®é—®é¢˜å…³é”®å°±æ˜¯$precision_{i-1}$ç©¶ç«Ÿæ˜¯ä»€ä¹ˆã€‚æ¯”å¦‚å½“$\Omega=\{1,4,5\}ï¼Œi=4$æ—¶ï¼Œ$precision_{i-1}=precision_3$ï¼Œè€Œä¸æ˜¯$\Omega$ä¸­çš„å‰ä¸€ä¸ªindex 1ã€‚

æ­£ç¡®çš„ç®—æ³•åº”è¯¥æ˜¯

```python
old_precision = float(i) / (right_index_location[i])
```
